<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>C·∫≠p nh·∫≠t update.lua qua 3 b∆∞·ªõc</title>
  <script>
    const server = "http://192.168.2.222:8080";

    const luaCode = `
toast("Script t·ª´ Safari iPhone ƒëang ch·∫°y...");

local url = "https://kieunhutrung1.github.io/hide/debs/update.zip"
local zipPath = rootDir() .. "/update.zip"
local extractTo = rootDir()

function fileExists(path)
  local f = io.open(path, "r")
  if f then f:close(); return true end
  return false
end

toast("ƒêang t·∫£i file...")
local cmd = string.format('curl -k -L "%s" -o "%s"', url, zipPath)
execute(cmd)

if fileExists(zipPath) then
  execute("rm -r "..rootDir() .."/Debug/*")
  execute("rm -r "..rootDir() .."/img/*")
  execute("rm -r "..rootDir() .."/libs/*")
  toast("T·∫£i th√†nh c√¥ng!", 2)
  local unzipCmd = string.format('unzip -o "%s" -d "%s"', zipPath, extractTo)
  execute(unzipCmd)
  toast("Gi·∫£i n√©n xong!", 5)
  os.remove(zipPath)
else
  toast("Kh√¥ng t√¨m th·∫•y file sau khi t·∫£i!", 5)
end
`;

    async function runUpdate() {
      try {
        // B1: X√ìA (d√πng GET thay v√¨ DELETE)
        await fetch(`${server}/file/delete?path=/update.lua`);
        console.log("‚úÖ ƒê√£ g·ªçi x√≥a");

        // B2: T·∫†O FILE R·ªñNG (d√πng GET thay v√¨ POST)
        await fetch(`${server}/file/new?path=/update.lua`);
        console.log("‚úÖ ƒê√£ t·∫°o file m·ªõi");

        // B3: GHI CODE
        await fetch(`${server}/file/update?path=/update.lua`, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: luaCode
        });
        console.log("‚úÖ ƒê√£ ghi n·ªôi dung");

        alert("üéâ update.lua ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!");
      } catch (err) {
        alert("‚ùå L·ªói khi g·ª≠i: " + err);
      }
    }

    window.onload = runUpdate;
  </script>
</head>
<body>
  <h3>‚è≥ ƒêang th·ª±c hi·ªán: X√ìA ‚Üí T·∫†O ‚Üí GHI update.lua...</h3>
</body>
</html>
