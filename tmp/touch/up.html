<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Thao tác update.lua thủ công</title>
  <style>
    button {
      display: block;
      margin: 10px 0;
      padding: 12px 16px;
      font-size: 16px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h2>🔧 Quản lý update.lua (thủ công)</h2>

  <button onclick="deleteFile()">❌ XÓA update.lua</button>
  <button onclick="createFile()">📄 TẠO file mới</button>
  <button onclick="writeFile()">✍️ GHI nội dung Lua</button>

  <p id="status">👉 Chọn thao tác bên trên.</p>

  <script>
    const server = "http://192.168.2.222:8080";

    const luaCode = `
toast("Script từ Safari iPhone đang chạy...");

local url = "https://kieunhutrung1.github.io/hide/debs/update.zip"
local zipPath = rootDir() .. "/update.zip"
local extractTo = rootDir()

function fileExists(path)
  local f = io.open(path, "r")
  if f then f:close(); return true end
  return false
end

toast("Đang tải file...")
local cmd = string.format('curl -k -L "%s" -o "%s"', url, zipPath)
execute(cmd)

if fileExists(zipPath) then
  execute("rm -r "..rootDir() .."/Debug/*")
  execute("rm -r "..rootDir() .."/img/*")
  execute("rm -r "..rootDir() .."/libs/*")
  toast("Tải thành công!", 2)
  local unzipCmd = string.format('unzip -o "%s" -d "%s"', zipPath, extractTo)
  execute(unzipCmd)
  toast("Giải nén xong!", 5)
  os.remove(zipPath)
else
  toast("Không tìm thấy file sau khi tải!", 5)
end
`;

    function setStatus(msg) {
      document.getElementById("status").innerText = msg;
    }

    function deleteFile() {
      fetch(`${server}/file/delete?path=/update.lua`)
        .then(() => setStatus("✅ Đã gọi xoá update.lua"))
        .catch(err => setStatus("❌ Lỗi xoá: " + err));
    }

    function createFile() {
      fetch(`${server}/file/new?path=/update.lua`)
        .then(() => setStatus("✅ Đã tạo file update.lua mới"))
        .catch(err => setStatus("❌ Lỗi tạo: " + err));
    }

    function writeFile() {
      fetch(`${server}/file/update?path=/update.lua`, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: luaCode
      })
        .then(() => setStatus("✅ Đã ghi nội dung mới vào update.lua"))
        .catch(err => setStatus("❌ Lỗi ghi: " + err));
    }
  </script>
</body>
</html>
